<dom-module id="webaudio-slider">
  <template>
    <div class="wac-body" id="wac-body">
      <div id="wac-knob"></div>
      <span id="wac-valuetip">{{valuestr}}</span>
      <div id="wac-tooltip-box"><span id="wac-tooltip-text">{{tooltip}}</span></div>
    </div>
    <div>
      <nav id="context-menuKnob" class="context-menu">
        <ul class="context-menu__items">
          <li class="context-menu__item" id="context-menu-learn" on-click="onClickLearn">
            Learn
          </li>
          <li class="context-menu__item" on-click="onClickClear">
            Clear
          </li>
          <li class="context-menu__item" on-click="toggleMenuOff">
            Close
          </li>
        </ul>
      </nav>
  </div>
    <style>
      :host {
        user-select: none;
        display: inline-block;
        font-family: sans-serif;
        font-size: 11px;
        padding:0;
        margin:0;
      }
      #wac-body {
        position: relative;
        display: inline-block;
      }
      #wac-knob {
        position: relative;
      }
      #wac-valuetip {
        position: absolute;
        top: -20px;
        left: 0;
        z-index: 10;
        display: none;
        opacity: 0;
        border: solid 1px #666;
        background-color: #fff;
        color: #000;
        border-radius: 4px;
        padding: 3px 8px;
        transition: opacity 0.3s;
      }
      #wac-tooltip-box {
        position: absolute;
        bottom: -24px;
        left: 20px;
        z-index: 10;
        display: none;
        opacity: 0;
        width: 200px;
        transition: opacity 0.5s;
      }
      #wac-tooltip-text {
        display: inline-block;
        border: solid 0px #666;
        background-color: #fff;
        color: #000;
        border-radius: 5px;
        padding: 5px;
      }
      /* CONTEXT MENU */
      /* context menu */

      .context-menu {
        display: none;
        position: absolute;
        z-index: 10;
        padding: 12px 0;
        width: 240px;
        background-color: #fff;
        border: solid 1px #dfdfdf;
        box-shadow: 1px 1px 2px #cfcfcf;
      }

      .context-menu--active {
        display: block;
      }

      .context-menu__items {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu__item {
        display: block;
        margin-bottom: 4px;
        padding: 4px 12px;
        color: #0066aa;
        text-decoration: none;
      }

      .context-menu__item:last-child {
        margin-bottom: 0;
      }


      .context-menu__item:hover {
        color: #fff;
        background-color: #0066aa;
      }      
  </style>
  </template>
  <script>
    Polymer({
      is:"webaudio-slider",

      properties:{
        value:      {type:Number, value:0, observer:'updateValue'},
        units:      {type:String, value:null},
        defvalue:   {type:Number, value:0},
        min:        {type:Number, value:0},
        max:        {type:Number, value:100},
        step:       {type:Number, value:1},
        width:      {type:Number, value:null, observer:'layout'},
        height:     {type:Number, value:null, observer:'layout'},
        knobwidth:  {type:Number, value:null},
        knobheight: {type:Number, value:null},
        ditchlength:{type:Number, value:null, observer:'layout'},
        length:     {type:Number, value:0},
        weight:     {type:Number, value:0},
        direction:  {type:String, value:'vert', observer:'layout'},
        knobsrc:    {type:String, value:null, observer:'setupImage'},
        sensitivity:{type:Number, value:1},
        digits:     {type:Number, value:0},
        src:        {type:String, value:""},
        valuetip:   {type:Number, value:1},
        tootip:     {type:String, value:null},
        colors:     {type:String, value:null, observer:'setupImage'},
        enable:     {type:Number, value:1},
        fconv:      {type:String, value:null},
        mode:       {type:String,value:"not"},
        vinput:     {type:Number,value:0} ,
        dinput:     {type:Number,value:0},
        learn:     {type:String, value:'true'},

        // for midi learn
        compId: {
          type:Number
        },
        midiMode: {
          type: String,
          value: "not"
        },
        midiControllers: {
          type: Array,
          value: []
        },
        menu: {
          type: String,
          value: null
        },
        menuVisible: {
          type: Boolean,
          value: false
        },
        taskItemClassName: {
          type: String,
          value: "knob"
        },
        lastShift: {
          type: Boolean,
          value: false
        },
        contextMenuLinkClassName: {
          type: String,
          value: "context-menu__link"
        },
        contextMenuActive: {
          type: String,
          value: "context-menu--active"
        },
        //windowHeigth: {type:Number,value:null},
        webAudioControllerWithMenu: {
          type: String,
          value: null
        }
      },

      preventScroll: function(e){
        e.preventDefault();
      },

      pointermove: function(e) {
        if(e.touches)
          e = e.touches[0];
        if(this.lastShift !== e.shiftKey) {
          this.lastShift = e.shiftKey;
          this.startPosX = e.pageX;
          this.startPosY = e.pageY;
          this.startVal = this.value;
        }
        if(this.direction == 'vert')
          var offset = (this.startPosY - e.pageY) / this._ditchlength;
        else
          var offset = (e.pageX - this.startPosX) / this._ditchlength;
        this.value = this.min + (((((this.startVal + (this.max - this.min) * offset * this.sensitivity / ((e.shiftKey ? 4:1))) - this.min) / this.step)|0) * this.step);
        e.preventDefault();
      },

      cancel: function(e) {
        this.press = this.vtflag = 0;
        this.showtip();
        this.startPosX = this.startPosY = null;
        window.removeEventListener('mousemove', this.boundPointermove, true);
        window.removeEventListener('touchmove', this.boundPointermove, true);
        window.removeEventListener('mouseup', this.boundCancel, true);
        window.removeEventListener('touchend', this.boundCancel, true);
        window.removeEventListener('touchcancel', this.boundCancel, true);
        document.body.removeEventListener('touchstart',this.preventScroll,false);
      },

      ready: function() {
        if(this.defvalue == null)
          this.defvalue = this.value;
        this.layout();
        var slib=this.$['wac-body'];
        var slik=this.$['wac-knob'];
        slib.addEventListener('DOMMouseScroll',this.wheel.bind(this),false);
        slib.addEventListener('mousewheel',this.wheel.bind(this),false);
        slib.addEventListener('mousedown',this.pointerdown.bind(this),false);
        slib.addEventListener('touchstart',this.pointerdown.bind(this),false);
        slib.addEventListener('mouseover',this.pointerover.bind(this),false);
        slib.addEventListener('mouseout',this.pointerout.bind(this),false);
        this.setupImage();
        slik.style.background = 'url('+this._knobsrc+')';
        slik.style.backgroundSize = '100% 100%';
        if(this.step && this.step < 1) {
          for(var n = this.step ; n < 1; n *= 10)
            ++this.digits;
        }

        // context menu
        slib.addEventListener("contextmenu", this.positionContextMenu.bind(this), false);
        window.addEventListener('keyup', this.keyupListener.bind(this), false);
        window.addEventListener('resize', this.resizeListener.bind(this), false);

        this.menu = this.$["context-menuKnob"];
        this.compId = Date.now();

      },

      pointerdown: function(e) {

        if(!this.enable)
          return;
        if(e.touches)
          e = e.touches[0];
        this.boundPointermove = this.pointermove.bind(this);
        this.boundCancel = this.cancel.bind(this);
        if(e.ctrlKey || e.metaKey)
          this.value = this.defvalue;
        else {
          if(this.valuetip)
            this.$['wac-valuetip'].style.opacity = 0.9;
          this.startPosX = e.pageX;
          this.startPosY = e.pageY;
          this.startVal = this.value;
          window.addEventListener('mousemove', this.boundPointermove, true);
          window.addEventListener('touchmove', this.boundPointermove, true);
        }
        window.addEventListener('mouseup', this.boundCancel, true);
        window.addEventListener('touchend', this.boundCancel, true);
        window.addEventListener('touchcancel', this.boundCancel, true);
        document.body.addEventListener('touchstart',this.preventScroll);
        this.press = this.vtflag = 1;
        this.ttflag = 0;
        this.showtip();
        e.preventDefault();
      },

      pointerover: function(e) {
        if(typeof(e.buttons)!="undefined")
          var btn = e.buttons;
        else
          var btn = e.which;
        if(btn==0)
          this.ttflag = 1;
        setTimeout(this.showtip.bind(this),700);
      },

      pointerout: function(e) {
        this.ttflag = 0;
        if(this.press==0)
          this.vtflag = 0;
        this.showtip();
      },

      showtip: function() {
        var vs=this.$['wac-valuetip'].style;
        var ts=this.$['wac-tooltip-box'].style;
        if(this.valuetip && this.vtflag) {
          if(this.vstim)
            clearTimeout(this.vstim);
          vs.display="block";
          setTimeout(function(){this.opacity=0.8;}.bind(vs),50);
        }
        else if(vs.opacity) {
          vs.opacity = 0;
          this.vtim=setTimeout(function(){if(this.vtflag==0) this.$['wac-valuetip'].style.display="none";}.bind(this),500);
        }
        if(this.tooltip && this.ttflag) {
          ts.display = "block";
          setTimeout(function(){this.opacity=0.8;}.bind(ts),100);
        }
        else if(ts.opacity) {
          ts.opacity = 0;
          setTimeout(function(){this.display="none";}.bind(ts),500);
        }
      },

      wheel: function(e) {
        var delta = 0;
        if(!e)
          e = window.event;
        if(e.wheelDelta)
          delta = e.wheelDelta/120;
        else if(e.detail)
          delta = -e.detail/3;
        if(e.shiftKey)
          delta *= 0.2;
        delta *= (this.max - this.min) * 0.05;
        if(Math.abs(delta) < this.step)
          delta = (delta>0)?this.step:-this.step;
        this.value += delta;
        //console.log(this.value);
        this.ttflag = 0;
        this.vtflag = 1;
        this.showtip();
        e.preventDefault();
      },

      layout: function(){
        var knob = this.$['wac-knob'];
        var body = this.$['wac-body'];
        this._width = parseFloat(this.width);
        this._height = parseFloat(this.height);
        if(this.width == null)
          this._width = (this.direction == 'vert' ? 24 : 128);
        if(this.height == null)
          this._height = (this.direction == 'vert' ? 256 : 24);
        if(!this.src)
          body.style.borderRadius = (Math.min(this._width,this._height)*.5)+'px';
        this._knobwidth = parseFloat(this.knobwidth);
        this._knobheight = parseFloat(this.knobheight);
        if(this.knobwidth == null)
          this._knobwidth = (this.direction == 'vert' ? this._width : this._height);
        if(this.knobheight == null)
          this._knobheight = (this.direction == 'vert' ? this._width : this._height);
        this._ditchlength = parseFloat(this.ditchlength);
        if(this.ditchlength == null)
          this._ditchlength = (this.direction =='vert' ? this._height - this._knobheight : this._width - this._knobwidth);
        if(knob&&body){
          knob.style.width = this._knobwidth+'px';
          knob.style.height = this._knobheight+'px';
          if(this.direction=='vert'){
            if(this._width)
              body.style.width = knob.style.width = this._width+"px";
            if(this._height)
              body.style.height = this._height+"px";
          }
          else{
            if(this._width)
              body.style.width = this._width+"px";
            if(this.height)
              body.style.height = knob.style.height = this._height+"px";
          }
          this.redraw();
        }
      },

      setupImage: function(){
        if(this.colors)
          this.coltab=this.colors.split(";");
        else
          this.coltab=["#e00","#000","#fff"];
        switch(this.coltab.length){
          case 1: this.coltab[1]=this.coltab[2]="#fff"; break;
          case 2: this.coltab[2]=this.coltab[0]; break;
        }
        var slib=this.$['wac-body'];
        if(this.src)
          slib.style.background = 'url('+this.src+')';
        else {
          slib.style.background = this.coltab[1];
          slib.style.borderRadius = (Math.min(this._width,this._height)*.5)+'px';
        }
        slib.style.backgroundSize = '100% 100%';
        this._knobsrc = this.knobsrc;
        if(!this.knobsrc){
          this._knobsrc = 'data:image/svg+xml;,%3csvg%20xmlns%3d%22http%3a%2f%2fwww%2ew3%2eorg%2f2000%2fsvg%22%20version%3d%221%2e1%22%20viewBox%3d%220%200%2010%2010%22%20preserveAspectRatio%3d%22none%22%3e%0d%0a%3cradialGradient%20id%3d%22g0%22%20fx%3d%22%2e3%22%20fy%3d%22%2e3%22%3e%3cstop%20offset%3d%220%22%20stop%2dcolor%3d%22'+encodeURIComponent(this.coltab[2])+'%22%2f%3e%3cstop%20offset%3d%22%2e75%22%20stop%2dcolor%3d%22'+encodeURIComponent(this.coltab[0])+'%22%2f%3e%3c%2fradialGradient%3e%0d%0a%3ccircle%20cx%3d%225%22%20cy%3d%225%22%20r%3d%224%22%20fill%3d%22url%28%23g0%29%22%2f%3e%0d%0a%3c%2fsvg%3e';
        }
      },

      setValue: function(value,fire){
        if(!fire)
          this.valueold = value;
        this.value = value;
      },

      updateValue: function() {
        var value = parseFloat(this.value);
        if(!isNaN(value)) {
          this.value = value < this.min ? this.min : value > this.max ? this.max : value;
          this.computedValue = (this.fconv ? eval("("+this.fconv+")")(this.value) : this.value);
          if(typeof(this.computedValue)=="number")
            this.valuestr = this.computedValue.toFixed(this.digits) + (this.units?this.units:"");
          else
            this.valuestr = this.computedValue;
          this.redraw();
          if(this.value != this.valueold) {
            this.valueold = this.value;
            this.fire('change');
          }
        }
      },

      redraw: function(){
        var range = this.max - this.min;
        var s=this.$['wac-knob'].style;
        if(this.direction == 'vert') {
          var pos = (this._height + this._ditchlength - this._knobheight)*0.5 - (this.value -this.min) / range * this._ditchlength;
          s.top = pos + "px";
          s.left = "0px";
        }
        else {
          var pos = (this._width - this._ditchlength - this._knobwidth)*0.5  + (this.value - this.min) / range * this._ditchlength;
          s.top = "0px";
          s.left = pos+"px";
        }
      },

      // MIDILEARN MENU
      positionContextMenu: function (e) {
        e.preventDefault();
        e.stopPropagation();
        this.toggleMenuOn(e);
        this.positionMenu(e);
      },
 
      keyupListener: function (e) {
        if (e.keyCode === 27 && this.menuVisible) {
          console.log("keyup");
          // Pressing ESC will close the menu
          this.toggleMenuOff(e);
        }
      },
      resizeListener: function (e) {
        // Hide menu if the window is resized
        console.log("resize");
        this.toggleMenuOff(e);
      },
      onClickLearn: function (e) {
        // Change label to "listening"
        //e.target.textContent = "Listening...";
        var menuItemLearn = this.$["context-menu-learn"];
        menuItemLearn.innerHTML = 'Listening...';
        this.midiMode = 'learn';
      },
      onClickClear: function (e) {
        this.toggleMenuOff(e);
        this.midiControllers = [];
      },
      toggleMenuOn: function (e) {
        if (!this.menuVisible) {
          this.menuVisible = true;
          this.menu.classList.add(this.contextMenuActive);
        }
      },
      toggleMenuOff: function (e) {
        if (this.menuVisible) {
         // Change the "listening..." label back to "learn"
          var menuItemLearn = this.$["context-menu-learn"];
          menuItemLearn.innerHTML = 'Learn';

          this.menuVisible = false;
          this.menu.classList.remove(this.contextMenuActive);
        }
      },
      // Get mouse pointer position
      getPosition: function (e) {
        var rect = e.target.getBoundingClientRect();
        var posx =  e.clientX - rect.left;
        var posy =  e.clientY - rect.top;
        //var posx = e.pageX - rect.width;
        //var posy = e.pageY - rect.height;
        return {
          x: posx,
          y: posy
        }
      },

      positionMenu: function (e) {
        let clickCoords = this.getPosition(e),
          menuWidth = this.menu.offsetWidth + 1,
          menuHeight = this.menu.offsetHeight + 1;
        if ((window.innerWidth - clickCoords.x) < menuWidth) {
          this.menu.style.left = window.innerWidth - menuWidth + "px";
        } else {
          this.menu.style.left = clickCoords.x + "px";
        }
        if ((window.innerHeight - clickCoords.y) < menuHeight) {
          this.menu.style.top = window.innerHeight - menuHeight + "px";
        } else {
          this.menu.style.top = clickCoords.y + "px";
        }
      },

      addMidiController: function (type, note) {
        if(this.listeningToThisMidiController(type, note)) return;

         this.midiControllers.push({
              'type': type,
              'note': note,
              'compId':this.compId,
              'tooltip': this.tooltip
            });
      },

      listeningToThisMidiController: function (type, note) {
        for (var i = 0; i < this.midiControllers.length; i++) {
          var c = this.midiControllers[i];
          if ((c.type === type && c.note === note && c.compId === this.compId)) {
            return true;
          }
        }
        return false;
      },

      processMidiEvent: function (event) {
        // Identify the controller
        var type = event.data[0];
        var note = event.data[1];
        if (this.midiMode === 'learn') {
          // add this controller to the list of controllers we're
          // listening to
          this.addMidiController(type, note);
          // hide menu
          this.toggleMenuOff(event);

          // set back mode to normal
          this.midiMode = 'normal';
 
        }
        // are we listening to this controller ?
        if (this.listeningToThisMidiController(type, note)) {
          // midi event value
          var val = event.data[2];
          // adjust taking into account the min and max attributes of the audiocontrol
          var adjustedValue = this.map(val, 0, 127, this.min, this.max);
          // set the webaudiocontrol value and pass true as second
          // argument to make it fire an input event as if the 
          // button was activated in the browser
          this.setValue(adjustedValue, true);
        }
      },
      // maps a value from [istart, istop] into [ostart, ostop]
      map: function (value, istart, istop, ostart, ostop) {
        return ostart + (ostop - ostart) * ((value - istart) / (istop - istart));
      }
  });
  </script>
</dom-module>
