<<dom-module id="webaudio-switch">
  <template>
    <div id="wac-body">
      <div id="wac-switch"></div>
      <div id="wac-tooltip-box"><span id="wac-tooltip-text">{{tooltip}}</span></div>
    </div>
    <div>
      <nav id="context-menuKnob" class="context-menu">
        <ul class="context-menu__items">
          <li class="context-menu__item" id="context-menu-learn" on-click="onClickLearn">
            Learn
          </li>
          <li class="context-menu__item" on-click="onClickClear">
            Clear
          </li>
          <li class="context-menu__item" on-click="toggleMenuOff">
            Close
          </li>
        </ul>
      </nav>
    </div>
    <style>
      :host {
        user-select: none;
        display: inline-block;
        font-family: sans-serif;
        font-size: 11px;
        padding:0;
        margin:0;
      }
      #wac-body {
        position: relative;
        display: inline-block;
        background: #000;
        border-radius: 5px;
      }
      #wac-switch {
        cursor: pointer;
        background-position: -64px;
      }
      #wac-tooltip-box {
        position: absolute;
        bottom: -24px;
        left: 20px;
        z-index: 10;
        display: none;
        opacity: 0;
        width: 200px;
        transition: opacity 0.5s;
      }
      #wac-tooltip-text {
        display: inline-block;
        border: solid 0px #666;
        background-color: #fff;
        color: #000;
        border-radius: 5px;
        padding: 5px;
      }

      /* CONTEXT MENU */
      /* context menu */

      .context-menu {
        display: none;
        position: absolute;
        z-index: 10;
        padding: 12px 0;
        width: 240px;
        background-color: #fff;
        border: solid 1px #dfdfdf;
        box-shadow: 1px 1px 2px #cfcfcf;
      }

      .context-menu--active {
        display: block;
      }

      .context-menu__items {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu__item {
        display: block;
        margin-bottom: 4px;
        padding: 4px 12px;
        color: #0066aa;
        text-decoration: none;
      }

      .context-menu__item:last-child {
        margin-bottom: 0;
      }


      .context-menu__item:hover {
        color: #fff;
        background-color: #0066aa;
      }        
    </style>
  </template>
  <script>
    Polymer({
      is:"webaudio-switch",

      properties:{
        value:      {type:Number, value:0, observer:'updateValue'},
        defvalue:   {type:Number, value:0},
        type:       {type:String, value:'toggle'},
        width:      {type:Number, value:24, observer:'layout'},
        height:     {type:Number, value:24, observer:'layout'},
        invert:     {type:Number, value:0},
        src:        {type:String, value:null},
        group:      {type:String, value:''},
        tooltip:    {type:String, value:null},
        colors:     {type:String, value:null, },
        enable:     {type:Number, value:1},
        mode:       {type:String,value:"not"},
        vinput:     {type:Number,value:0} ,
        dinput:     {type:Number,value:0},
        mode:       {type:String,value:"not"},
        learn:     {type:String, value:'true'},
        // for midi learn
        compId: {
          type:Number
        },
        midiMode: {
          type: String,
          value: "not"
        },
        midiControllers: {
          type: Array,
          value: []
        },
        menu: {
          type: String,
          value: null
        },
        menuVisible: {
          type: Boolean,
          value: false
        },
        taskItemClassName: {
          type: String,
          value: "knob"
        },
        lastShift: {
          type: Boolean,
          value: false
        },
        contextMenuLinkClassName: {
          type: String,
          value: "context-menu__link"
        },
        contextMenuActive: {
          type: String,
          value: "context-menu--active"
        },
        //windowHeigth: {type:Number,value:null},
        webAudioControllerWithMenu: {
          type: String,
          value: null
        }
      },
      cancel: function(e) {
        window.removeEventListener('mouseup', this.boundUp, true);
        window.removeEventListener('touchend', this.boundUp, true);
        window.removeEventListener('touchcancel', this.boundCancel, true);
        if(this.type=="kick")
          this.setValue(0);
        this.press = 0;
      },

      up: function(e) {
        window.removeEventListener('mouseup', this.boundUp, true);
        window.removeEventListener('touchend', this.boundUp, true);
        window.removeEventListener('touchcancel', this.boundCancel, true);
        if(this.type=="kick") {
          if(this.value) {
            this.value = 0;
            this.fire('click');
          }
        }
        this.press = 0;
        e.preventDefault();
        return false;
      },

      ready: function() {
        var body = this.$['wac-body'];
        var sw = this.$['wac-switch'];
        sw.addEventListener('mousedown',this.pointerdown.bind(this),false);
        sw.addEventListener('mouseover',this.pointerover.bind(this),false);
        sw.addEventListener('mouseout',this.pointerout.bind(this),false);
        sw.addEventListener('click',this.click.bind(this),false);
        this.setupImage();
        this.layout();
        sw.style.backgroundSize = '100% 200%';
        if(this.defvalue === null)
          this.defvalue = this.value;
        this.redraw();

        // context menu
        sw.addEventListener("contextmenu", this.positionContextMenu.bind(this), false);
        window.addEventListener('keyup', this.keyupListener.bind(this), false);
        window.addEventListener('resize', this.resizeListener.bind(this), false);

        this.menu = this.$["context-menuKnob"];
        this.compId = Date.now();
      },

      pointerdown: function(e) {
        if(e.type !== 'mousedown' || e.button !== 0) return;

        console.log("pointer down")
        if(!this.enable)
          return;
        this.boundCancel = this.cancel.bind(this);
        this.boundUp = this.up.bind(this);
        window.addEventListener('mouseup', this.boundUp, true);
        window.addEventListener('touchend', this.boundUp, true);
        window.addEventListener('touchcancel', this.boundCancel, true);
        switch(this.type) {
          case 'kick':
            this.value = 1;
            break;
          case 'toggle':
            if(e.ctrlKey || e.metaKey)
              this.value = defvalue;
            else
              this.value = 1 - this.value;
            break;
          case 'radio':
            this.value = 1;
            break;
        }
        this.press = 1;
        this.ttflag = 0;
        this.showtip();
        e.preventDefault();
      },

      pointerover: function(e) {
        if(typeof(e.buttons) != "undefined")
          var btn = e.buttons;
        else
          var btn = e.which;
        if(btn==0)
          this.ttflag = 1;
        setTimeout(this.showtip.bind(this),700);
        this.hover = 1;
        if(this.type == "kick" && this.press)
          this.value = 1;
      },

      pointerout: function(e) {
        this.ttflag = 0;
        if(this.press == 0)
          this.vtflag = 0;
        this.showtip();
        this.hover = 0;
        if(this.type == "kick")
          this.value = 0;
      },

      showtip: function() {
        var ts=this.$['wac-tooltip-box'].style;
        if(this.tooltip && this.ttflag) {
          ts.display="block";
          setTimeout(function(){this.opacity=0.8;}.bind(ts),100);
        }
        else if(ts.opacity) {
          ts.opacity = 0;
          setTimeout(function(){this.display="none";}.bind(ts),500);
        }
      },

      click: function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      },

      layout: function(){
        var sw = this.$['wac-switch'];
        sw.style.width = this.width+'px';
        sw.style.height = this.height+'px';
        this.redraw();
      },

      setupImage: function(){
        if(this.colors)
          this.coltab=this.colors.split(";");
        else
          this.coltab=["#e00","#000","#fff"];
        switch(this.coltab.length){
          case 1: this.coltab[1]=this.coltab[2]="#fff"; break;
          case 2: this.coltab[2]=this.coltab[0]; break;
        }
        var body=this.$['wac-body'];
        var sw=this.$['wac-switch'];
        if(this.src){
          body.style.background = 'rgba(0,0,0,0)';
          sw.style.background = 'url('+this.src+')';
        }
        else {
          body.style.background = this.coltab[1];
          body.style.borderRadius = Math.min(this.width*.5,this.height*.5,5)+'px';
          sw.style.background = 'url(data:image/svg+xml;,%3csvg%20xmlns%3d%22http%3a%2f%2fwww%2ew3%2eorg%2f2000%2fsvg%22%20version%3d%221%2e1%22%20viewBox%3d%220%200%2010%2020%22%20preserveAspectRatio%3d%22none%22%3e%0d%0a%3cradialGradient%20id%3d%22g0%22%20fx%3d%22%2e3%22%20fy%3d%22%2e3%22%3e%3cstop%20offset%3d%220%22%20stop%2dcolor%3d%22'+encodeURIComponent(this.coltab[2])+'%22%2f%3e%3cstop%20offset%3d%22%2e75%22%20stop%2dcolor%3d%22'+encodeURIComponent(this.coltab[0])+'%22%2f%3e%3c%2fradialGradient%3e%0d%0a%3ccircle%20cx%3d%225%22%20cy%3d%225%22%20r%3d%223%22%20stroke%2dwidth%3d%22%2e5%22%20stroke%3d%22'+encodeURIComponent(this.coltab[0])+'%22%20fill%3d%22none%22%2f%3e%0d%0a%3ccircle%20cx%3d%225%22%20cy%3d%2215%22%20r%3d%223%22%20fill%3d%22url%28%23g0%29%22%2f%3e%0d%0a%3c%2fsvg%3e)';
        }
      },

      setValue: function(value,fire){
        if(!fire)
          this.valueold = value;
        this.value = value;
      },

      updateValue: function() {
        this.value = parseInt(this.value);
        this.valuestr = this.value;
        this.redraw();
        var el = document.getElementsByTagName('webaudio-switch');
        if(this.value == 1) {
          for(var i = 0, j = el.length; i < j; ++i) {
            if(this.group && el[i] != this && el[i].group == this.group){
              if(this.valueold == 1)
                el[i].valueold = 0;
              el[i].value = 0;
            }
          }
        }
        if(this.value != this.valueold){
          this.fire('change');
          this.valueold = this.value;
        }
      },

      redraw: function(){
        this.$['wac-switch'].style.backgroundPosition = '0px -' + ((this.value^this.invert) * this.height) + 'px';
      },

      // MIDILEARN MENU
      positionContextMenu: function (e) {
        e.preventDefault();
        e.stopPropagation();
        this.toggleMenuOn(e);
        this.positionMenu(e);
      },
 
      keyupListener: function (e) {
        if (e.keyCode === 27 && this.menuVisible) {
          console.log("keyup");
          // Pressing ESC will close the menu
          this.toggleMenuOff(e);
        }
      },
      resizeListener: function (e) {
        // Hide menu if the window is resized
        console.log("resize");
        this.toggleMenuOff(e);
      },
      onClickLearn: function (e) {
        // Change label to "listening"
        //e.target.textContent = "Listening...";
        var menuItemLearn = this.$["context-menu-learn"];
        menuItemLearn.innerHTML = 'Listening...';
        this.midiMode = 'learn';
      },
      onClickClear: function (e) {
        this.toggleMenuOff(e);
        this.midiControllers = [];
      },
      toggleMenuOn: function (e) {
        if (!this.menuVisible) {
          this.menuVisible = true;
          this.menu.classList.add(this.contextMenuActive);
        }
      },
      toggleMenuOff: function (e) {
        if (this.menuVisible) {
         // Change the "listening..." label back to "learn"
          var menuItemLearn = this.$["context-menu-learn"];
          menuItemLearn.innerHTML = 'Learn';

          this.menuVisible = false;
          this.menu.classList.remove(this.contextMenuActive);
        }
      },
      // Get mouse pointer position
      getPosition: function (e) {
        var rect = e.target.getBoundingClientRect();
        var posx =  e.clientX - rect.left;
        var posy =  e.clientY - rect.top;
        //var posx = e.pageX - rect.width;
        //var posy = e.pageY - rect.height;
        return {
          x: posx,
          y: posy
        }
      },

      positionMenu: function (e) {
        let clickCoords = this.getPosition(e),
          menuWidth = this.menu.offsetWidth + 1,
          menuHeight = this.menu.offsetHeight + 1;
        if ((window.innerWidth - clickCoords.x) < menuWidth) {
          this.menu.style.left = window.innerWidth - menuWidth + "px";
        } else {
          this.menu.style.left = clickCoords.x + "px";
        }
        if ((window.innerHeight - clickCoords.y) < menuHeight) {
          this.menu.style.top = window.innerHeight - menuHeight + "px";
        } else {
          this.menu.style.top = clickCoords.y + "px";
        }
      },

      addMidiController: function (type, note) {
        if(this.listeningToThisMidiController(type, note)) return;

         this.midiControllers.push({
              'type': type,
              'note': note,
              'compId':this.compId,
              'tooltip': this.tooltip
            });
      },

      listeningToThisMidiController: function (type, note) {
        for (var i = 0; i < this.midiControllers.length; i++) {
          var c = this.midiControllers[i];
          if ((c.type === type && c.note === note && c.compId === this.compId)) {
            return true;
          }
        }
        return false;
      },

      processMidiEvent: function (event) {
        // Identify the controller
        var type = event.data[0];
        var note = event.data[1];
        if (this.midiMode === 'learn') {
          // add this controller to the list of controllers we're
          // listening to
          this.addMidiController(type, note);
          // hide menu
          this.toggleMenuOff(event);

          // set back mode to normal
          this.midiMode = 'normal';
 
        }
        // are we listening to this controller ?
        if (this.listeningToThisMidiController(type, note)) {
          if(this.type=="kick") {
            if(this.value) {
              this.value = 0;
              this.fire('click');
            }
          }
          this.press = 0;
          //preventDefault();
          switch(this.type) {
          case 'kick':
            this.value = 1;
            break;
          case 'toggle':
              this.value = 1 - this.value;
            break;
          case 'radio':
            this.value = 1;
            break;
        }
        this.press = 1;
        this.ttflag = 0;
        this.showtip();
          return false;
          }
      },
      // maps a value from [istart, istop] into [ostart, ostop]
      map: function (value, istart, istop, ostart, ostop) {
        return ostart + (ostop - ostart) * ((value - istart) / (istop - istart));
      }
    });
  </script>
</dom-module>
